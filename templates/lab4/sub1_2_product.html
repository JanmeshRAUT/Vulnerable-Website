{% extends 'base.html' %}
{% block title %}Product Detail - {{ product.name }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/lab4_1a.css') }}">
{% endblock %}

{% block content %}
    <a href="{{ url_for('lab4_1_2') }}" class="btn">&larr; Back to Shop</a>

    <div class="detail-container-a">
        <div class="detail-card-a">
            <div class="detail-image-box-a" style="padding: 0; background: #000; overflow: hidden;">
                <img src="{{ product.image }}" alt="{{ product.name }}" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <div class="detail-content-a">
                <div class="detail-header-a">
                    <h1>{{ product.name }}</h1>
                    <p style="color: #94a3b8; line-height: 1.6; margin-bottom: 2rem;">{{ product.description }}</p>
                </div>
                <div class="detail-price-a">${{ product.price }}</div>
                
                <div class="stock-box-a">
                    <form action="{{ url_for('lab4_stock_check') }}" method="POST" id="stockForm">
                        <input type="hidden" name="stockApi" value="http://192.168.0.1:8080/product/stock/check?productId={{ product.id }}&storeId=1">
                        <button type="submit" class="stock-btn-a">Check Stock</button>
                    </form>
                    <div id="stockResult" class="stock-result-a"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('stockForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const resultDiv = document.getElementById('stockResult');
            resultDiv.innerText = "Checking...";
            resultDiv.style.color = "#94a3b8";
            
            const formData = new FormData(this);
            const urlEncodedData = new URLSearchParams(formData).toString();

            fetch('/product/stock', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: urlEncodedData
            })
            .then(res => res.text())
            .then(data => {
                // If the response is HTML (admin panel), render it in a contained way
                 if (data.includes('Admin Interface') || data.includes('User deleted')) {
                     resultDiv.innerHTML = "<div style='color: #fbbf24; border: 1px solid #fbbf24; padding: 1rem; background: rgba(251, 191, 36, 0.1);'>" + data + "</div>";
                } else if (data.includes('500') || data.includes('Internal Server Error')) {
                     resultDiv.innerText = "Check failed: " + data;
                     resultDiv.style.color = "#ef4444";
                } else {
                     resultDiv.innerText = data;
                     resultDiv.style.color = "#10b981";
                }
            })
            .catch(err => {
                resultDiv.innerText = "Error: " + err;
                resultDiv.style.color = "#ef4444";
            });
        });
    </script>
{% endblock %}
