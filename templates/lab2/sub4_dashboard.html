
{% extends 'base.html' %}
{% block title %}Lab 2.4: Dashboard{% endblock %}

{% block content %}
    <a href="{{ url_for('lab2_4') }}" class="btn">Back to Login</a>

    <h2>My Dashboard</h2>
    <div class="banner">
        ⚠️ An update request is sent automatically when you view this page.
    </div>

    <div class="card">
        <h3>User Profile</h3>
        <p><strong>GUID:</strong> <span id="guid">{{ guid }}</span></p>
        <p><strong>Username:</strong> <span id="username">{{ username }}</span></p>
        <p><strong>Role:</strong> <span id="role">Loading...</span></p>
        
        <div id="output" class="alert" style="display:none; word-break: break-all;"></div>
    </div>
    
    <div class="alert alert-error">
        Hint: Check the API request in Burp Suite (<code>/lab2/4/api/update_profile</code>).
        <br>Try changing your username to <code>admin</code> in the request body.
    </div>

    <script>
        // Simulating a profile refresh/update on load
        window.addEventListener('load', function() {
            const guid = document.getElementById('guid').innerText;
            const username = document.getElementById('username').innerText;
            
            fetch('/lab2/4/api/update_profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    guid: guid,
                    username: username
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('role').innerText = data.role;
                const output = document.getElementById('output');
                output.style.display = 'block';
                
                if (data.flag) {
                    output.className = 'alert alert-success';
                    output.innerHTML = `<strong>SUCCESS!</strong> ${data.flag}`;
                    // Popup if flag is present (User Request)
                    alert("Congratulations! " + data.flag);
                } else {
                    output.className = 'alert';
                    output.innerText = data.message;
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    </script>
{% endblock %}
